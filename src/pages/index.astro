---
import reposData from '../data/repos.json';
import mediaData from '../data/media.json';
import '../styles/global.css';

const categories = ["All", ...new Set([...reposData.map(r => r.category), ...mediaData.map(m => m.category)])];

// Enhanced Fetch Logic with Level Support
const repos = await Promise.all(reposData.map(async (repo) => {
  try {
    const res = await fetch(`https://api.github.com/repos/${repo.id}`, {
      headers: import.meta.env.GITHUB_TOKEN ? { Authorization: `token ${import.meta.env.GITHUB_TOKEN}` } : {}
    });
    const data = await res.json();
    return {
      id: repo.id,
      name: data.name || repo.id.split('/')[1],
      desc: repo.customDesc || data.description || "Essential AI resource.",
      stars: data.stargazers_count ? (data.stargazers_count / 1000).toFixed(1) + 'k' : '0.0k',
      url: data.html_url,
      category: repo.category,
      level: repo.level || "Beginner",
      type: "Code",
      isStarter: repo.starter || false
    };
  } catch (e) {
    return { id: repo.id, name: repo.id, desc: "Source link", stars: "—", url: `https://github.com/${repo.id}`, category: repo.category, type: "Code", level: repo.level || "Beginner", isStarter: repo.starter || false };
  }
}));

const allGems = [...repos, ...mediaData.map(m => ({ ...m, id: m.url, name: m.title, stars: m.type, type: "Media", isStarter: m.starter || false }))];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<title>AetherIndex // AI Mastery Foundry</title>

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://aether-index.vercel.app/" />
		<meta property="og:title" content="AetherIndex // The AI Beginner's Foundry" />
		<meta property="og:description" content="A curated lifesaver for new developers. 100+ elite AI repositories, Stanford/Harvard courses, and technical roadmaps." />
		<meta property="og:image" content="https://aether-index.vercel.app/og_image.png" />

		<!-- Twitter / X -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content="https://aether-index.vercel.app/" />
		<meta property="twitter:title" content="AetherIndex // The AI Beginner's Foundry" />
		<meta property="twitter:description" content="Master AI through hands-on playing with the world's most vital open-source repositories." />
		<meta property="twitter:image" content="https://aether-index.vercel.app/og_image.png" />
	</head>
	<body class="bg-[#02040a] text-white font-sans selection:bg-blue-500/30">
		
		<nav class="border-b border-white/5 bg-black/60 backdrop-blur-xl sticky top-0 z-50">
			<div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
				<div class="flex items-center gap-2">
					<div class="w-5 h-5 bg-blue-500 rounded-full animate-pulse"></div>
					<span class="font-bold tracking-tighter uppercase italic text-lg text-white">Aether<span class="text-blue-500">Index</span></span>
				</div>
                <div class="flex items-center gap-6">
                    <a href="/getting-started" class="text-[10px] font-mono uppercase tracking-widest text-blue-400 hover:text-white transition-colors animate-pulse">
                        New? Start here →
                    </a>
                    <a 
                        href="https://github.com/abhisek-padhy/aether-index/issues/new?template=submit-gem.yml" 
                        target="_blank"
                        class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-4 py-2 uppercase tracking-tight rounded transition-all"
                    >
                        Submit Entry
                    </a>
                    <button id="show-favs" class="text-[10px] font-mono uppercase tracking-widest text-slate-400 hover:text-yellow-500 transition-colors">
                        Bookmarks (<span id="fav-count">0</span>)
                    </button>
                </div>
			</div>
		</nav>

		<div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row gap-16 py-24">
			<aside class="w-full md:w-64 flex-shrink-0">
				<div class="sticky top-28">
					<h3 class="text-[10px] font-mono uppercase tracking-[0.25em] text-slate-500 mb-6">Mastery_Sectors</h3>
					<nav class="flex flex-col gap-1">
						{categories.map(cat => (
							<button class="cat-btn text-left px-4 py-3 rounded-xl border border-transparent text-xs font-medium text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center justify-between group" data-category={cat}>
								{cat}
								<span class="opacity-0 group-hover:opacity-100 transition-all text-blue-500 translate-x-[-10px] group-hover:translate-x-0">→</span>
							</button>
						))}
					</nav>
				</div>
			</aside>

			<main class="flex-1">
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="foundry-grid">
					{allGems.map(gem => (
						<div class="laser-card p-10 group relative flex flex-col justify-between h-full" data-category={gem.category} data-type={gem.type} data-id={gem.id} data-name={gem.name.toLowerCase()}>
							<div>
								<div class="flex justify-between items-start mb-6">
									<div class="flex flex-col gap-2">
                                        <span class={`text-[8px] font-mono uppercase tracking-tighter px-2 py-0.5 rounded w-fit border ${
                                            gem.level === 'Advanced' ? 'border-red-500/40 text-red-400 bg-red-500/5' : 
                                            gem.level === 'Intermediate' ? 'border-blue-500/40 text-blue-400 bg-blue-500/5' : 
                                            'border-green-500/40 text-green-400 bg-green-500/5'
                                        }`}>
                                            {gem.level || 'Beginner'}
                                        </span>
                                        <span class="text-[9px] font-mono text-slate-500 uppercase italic">{gem.category}</span>
                                    </div>
                                    <button class="fav-btn text-slate-600 hover:text-yellow-500 transition-colors" data-id={gem.id}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>
                                    </button>
								</div>
								
                                <h3 class="text-2xl font-bold text-white group-hover:text-blue-400 transition-colors mb-4 tracking-tight uppercase italic">{gem.name}</h3>
								<p class="text-sm text-slate-500 leading-relaxed font-light italic line-clamp-3 mb-8">{gem.desc}</p>
							</div>
							
                            <div class="pt-6 border-t border-white/5 flex items-center justify-between">
								<a href={gem.url} target="_blank" class="text-[9px] font-mono uppercase tracking-[0.2em] text-blue-400 hover:text-white transition-colors">
                                    Launch_Module →
                                </a>
								<div class="text-[10px] text-slate-700 font-mono uppercase">{gem.stars}</div>
							</div>
						</div>
					))}
				</div>
			</main>
		</div>

		<script>
			const favButtons = document.querySelectorAll('.fav-btn');
            const favCountDisplay = document.getElementById('fav-count');
            const showFavsBtn = document.getElementById('show-favs');
            const cards = document.querySelectorAll('.laser-card') as NodeListOf<HTMLElement>;

            // --- FAVORITES LOGIC ---
            function getFavorites() {
                return JSON.parse(localStorage.getItem('aether_bookmarks') || '[]');
            }

            function updateUI() {
                const favs = getFavorites();
                if (favCountDisplay) favCountDisplay.innerText = favs.length;
                
                favButtons.forEach(btn => {
                    const id = btn.getAttribute('data-id');
                    const svg = btn.querySelector('svg');
                    if (id && favs.includes(id)) {
                        svg?.setAttribute('fill', '#eab308'); // yellow-500
                        btn.classList.add('text-yellow-500');
                    } else {
                        svg?.setAttribute('fill', 'none');
                        btn.classList.remove('text-yellow-500');
                    }
                });
            }

            favButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    let favs = getFavorites();
                    
                    if (id) {
                        if (favs.includes(id)) {
                            favs = favs.filter((f: string) => f !== id);
                        } else {
                            favs.push(id);
                        }
                        localStorage.setItem('aether_bookmarks', JSON.stringify(favs));
                        updateUI();
                    }
                });
            });

            // Filter to show only Bookmarks
            let showingOnlyFavs = false;
            showFavsBtn?.addEventListener('click', () => {
                showingOnlyFavs = !showingOnlyFavs;
                const favs = getFavorites();
                
                cards.forEach(card => {
                    const id = card.getAttribute('data-id');
                    if (showingOnlyFavs) {
                        card.style.display = (id && favs.includes(id)) ? 'flex' : 'none';
                        showFavsBtn.classList.add('text-yellow-500');
                    } else {
                        card.style.display = 'flex';
                        showFavsBtn.classList.remove('text-yellow-500');
                    }
                });
            });

            // Initial UI Sync
            updateUI();
		</script>
	</body>
</html>