---
import reposData from '../data/repos.json';
import mediaData from '../data/media.json';
import '../styles/global.css';

const categories = ["All", ...new Set([...reposData.map(r => r.category), ...mediaData.map(m => m.category)])];

// Fetch Repo Data with Star Counts
const repos = await Promise.all(reposData.map(async (repo) => {
  try {
    const res = await fetch(`https://api.github.com/repos/${repo.id}`, {
      headers: import.meta.env.GITHUB_TOKEN ? { Authorization: `token ${import.meta.env.GITHUB_TOKEN}` } : {}
    });
    const data = await res.json();
    return {
      name: data.name || repo.id.split('/')[1],
      desc: repo.customDesc || data.description || "Essential resource for AI engineering mastery.",
      stars: data.stargazers_count ? (data.stargazers_count / 1000).toFixed(1) + 'k' : '0.0k',
      url: data.html_url,
      category: repo.category,
      type: "Code",
      isStarter: repo.starter || false
    };
  } catch (e) {
    return { name: repo.id, desc: "Source link", stars: "—", url: `https://github.com/${repo.id}`, category: repo.category, type: "Code", isStarter: repo.starter || false };
  }
}));

// Combine with Media Data
const allGems = [...repos, ...mediaData.map(m => ({ ...m, name: m.title, stars: m.type, type: "Media", isStarter: m.starter || false }))];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<title>AetherIndex // The AI Beginner's Foundry</title>
	</head>
	<body class="bg-[#02040a] text-white selection:bg-blue-500/30 font-sans">
		
		<nav class="border-b border-white/5 bg-black/60 backdrop-blur-xl sticky top-0 z-50">
			<div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
				<div class="flex items-center gap-2">
					<div class="w-5 h-5 bg-blue-500 rounded-full animate-pulse"></div>
					<span class="font-bold tracking-tighter uppercase italic text-lg">Aether<span class="text-blue-500">Index</span></span>
				</div>
				<div class="hidden md:flex gap-6 text-[10px] font-mono uppercase tracking-[0.2em] text-slate-500">
					<button class="type-btn active text-white" data-type="All">The Manifest</button>
					<button class="type-btn" data-type="Code">Source_Repo</button>
					<button class="type-btn" data-type="Media">Watch_Session</button>
				</div>
				<button class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-4 py-2 uppercase tracking-tight rounded transition-all">Submit Gem</button>
			</div>
		</nav>

		<header class="relative py-32 border-b border-white/5 overflow-hidden">
			<div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,#1e1b4b,transparent)] opacity-40"></div>
			<div class="relative max-w-5xl mx-auto px-6 text-center">
				<h1 class="text-6xl md:text-8xl font-black tracking-tighter mb-8 leading-[0.9] uppercase italic">AI ENGINEER<br/><span class="text-blue-500 italic">FOUNDRY.</span></h1>
				<p class="text-xl text-slate-400 font-light max-w-2xl mx-auto leading-relaxed mb-12 italic">Your hands-on roadmap from <span class="text-white italic">Scratch</span> to <span class="text-white italic">Mastery</span>.</p>
				<div class="max-w-md mx-auto flex gap-2 p-1.5 bg-white/[0.03] border border-white/10 rounded-xl">
					<input type="email" placeholder="Join the weekly roadmap..." class="bg-transparent flex-1 px-4 py-2 text-sm outline-none font-mono" />
					<button class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg text-xs font-bold uppercase transition-all">Join</button>
				</div>
			</div>
		</header>

		<div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row gap-16 py-24">
			<aside class="w-full md:w-64 flex-shrink-0">
				<div class="sticky top-28">
					<h3 class="text-[10px] font-mono uppercase tracking-[0.25em] text-slate-500 mb-6">Foundry_Sectors</h3>
					<nav class="flex flex-col gap-1">
						{categories.map(cat => (
							<button class="cat-btn text-left px-4 py-3 rounded-xl border border-transparent text-xs font-medium text-slate-400 hover:bg-white/5 hover:text-white transition-all flex items-center justify-between group" data-category={cat}>
								{cat}
								<span class="opacity-0 group-hover:opacity-100 transition-all text-blue-500 translate-x-[-10px] group-hover:translate-x-0">→</span>
							</button>
						))}
					</nav>
					<div class="mt-12 p-6 rounded-2xl border border-blue-500/10 bg-blue-500/5 backdrop-blur-sm">
						<h4 class="text-[10px] font-mono uppercase text-blue-400 mb-3 italic">Lifesaver Path</h4>
						<p class="text-[11px] text-slate-400 leading-relaxed italic">Start with <span class="text-white italic">Foundations</span> and prioritize yellow badges.</p>
					</div>
				</div>
			</aside>

			<main class="flex-1">
				<div class="mb-12">
					<input type="text" id="gem-search" placeholder="Search gems (e.g., 'Andrej', 'Math', 'Agents')..." class="w-full bg-white/[0.02] border border-white/10 rounded-2xl px-6 py-5 text-sm font-mono text-white focus:border-blue-500/50 transition-all outline-none" />
				</div>
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="foundry-grid">
					{allGems.map(gem => (
						<a href={gem.url} target="_blank" class="laser-card p-10 group block relative flex flex-col justify-between" data-category={gem.category} data-type={gem.type} data-name={gem.name.toLowerCase()}>
							<div>
								<div class="flex justify-between items-start mb-8">
									<span class="text-[9px] font-mono text-blue-400 bg-blue-400/10 px-3 py-1 rounded-full uppercase italic">{gem.category}</span>
									{gem.isStarter && <span class="text-[9px] font-bold text-yellow-500 bg-yellow-500/10 border border-yellow-500/20 px-2 py-0.5 rounded animate-pulse">★ STARTER KIT</span>}
								</div>
								<h3 class="text-2xl font-bold text-white group-hover:text-blue-400 transition-colors mb-4 tracking-tight uppercase italic">{gem.name}</h3>
								<p class="text-sm text-slate-500 leading-relaxed font-light italic line-clamp-3 mb-8">{gem.desc}</p>
							</div>
							<div class="pt-6 border-t border-white/5 flex items-center justify-between italic">
								<span class="text-[9px] font-mono uppercase tracking-[0.2em] text-slate-600 group-hover:text-blue-500 transition-colors">{gem.type === "Code" ? "Explore_Source" : "Watch_Session"}</span>
								<div class="text-[10px] text-slate-700 font-mono group-hover:text-white transition-colors uppercase">{gem.stars}</div>
							</div>
						</a>
					))}
				</div>
			</main>
		</div>

		<footer class="mt-40 border-t border-white/5 py-24 bg-[#010206] text-center">
			<div class="font-bold tracking-tighter uppercase italic text-2xl mb-4">Aether<span class="text-blue-500">Index</span></div>
			<p class="text-xs text-slate-500 font-mono uppercase tracking-widest italic mb-10">From scratch to AI Mastery. Curated for the modern manifest.</p>
			<div class="flex justify-center gap-10 text-[10px] font-mono uppercase tracking-widest text-slate-700">
				<a href="#" class="hover:text-blue-400 transition-colors">Privacy_Protocol</a>
				<a href="#" class="hover:text-blue-400 transition-colors">Archive_Log</a>
			</div>
		</footer>

		<script>
			const searchInput = document.getElementById('gem-search') as HTMLInputElement;
			const catButtons = document.querySelectorAll('.cat-btn');
			const typeButtons = document.querySelectorAll('.type-btn');
			const gridItems = document.querySelectorAll('#foundry-grid > a') as NodeListOf<HTMLElement>;

			let currentCat = "All";
			let currentType = "All";

			function filterGems() {
				const term = searchInput.value.toLowerCase();
				gridItems.forEach(item => {
					const name = item.getAttribute('data-name') || "";
					const cat = item.getAttribute('data-category') || "";
					const type = item.getAttribute('data-type') || "";

					const matchesSearch = name.includes(term);
					const matchesCat = currentCat === "All" || cat === currentCat;
					const matchesType = currentType === "All" || type === currentType;

					item.style.display = (matchesSearch && matchesCat && matchesType) ? 'block' : 'none';
				});
			}

			searchInput?.addEventListener('input', filterGems);
			catButtons.forEach(btn => btn.addEventListener('click', () => {
				catButtons.forEach(b => b.classList.remove('bg-white/5', 'text-white'));
				btn.classList.add('bg-white/5', 'text-white');
				currentCat = btn.getAttribute('data-category') || "All";
				filterGems();
			}));
			typeButtons.forEach(btn => btn.addEventListener('click', () => {
				typeButtons.forEach(b => b.classList.remove('text-white', 'active'));
				btn.classList.add('text-white', 'active');
				currentType = btn.getAttribute('data-type') || "All";
				filterGems();
			}));
		</script>
	</body>
</html>